<ion-content>
  <div class="donate-container">
    <div class="header-section">
      <h1 class="page-title">Doar um Livro</h1>
      <p class="page-subtitle">Preencha as informações abaixo para disponibilizar o seu livro para doação.</p>
    </div>

    <form [formGroup]="donateForm" (ngSubmit)="onSubmit()" class="donate-form">
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-lg="6" class="form-column">
            <div class="input-group">
              <ion-label>Título do Livro *</ion-label>
              <ion-item class="custom-input">
                <ion-input formControlName="title"></ion-input>
              </ion-item>
            </div>
            <div class="input-group">
              <ion-label>Autor *</ion-label>
              <ion-item class="custom-input">
                <ion-input formControlName="author"></ion-input>
              </ion-item>
            </div>
            <div class="input-group">
              <ion-label>Estado do Livro *</ion-label>
              <ion-item class="custom-input">
                <ion-select formControlName="condition" interface="popover" placeholder="Selecione o estado">
                  <ion-select-option value="novo">Novo</ion-select-option>
                  <ion-select-option value="excelente">Excelente</ion-select-option>
                  <ion-select-option value="bom">Bom</ion-select-option>
                  <ion-select-option value="usado">Usado</ion-select-option>
                </ion-select>
              </ion-item>
            </div>
            <div class="input-group">
              <ion-label>Categoria (Género) *</ion-label>
              <ion-item class="custom-input">
                <ion-select formControlName="genre" interface="popover" placeholder="Selecione uma categoria">
                  <ion-select-option value="romance">Romance</ion-select-option>
                  <ion-select-option value="ficcao">Ficção</ion-select-option>
                  <ion-select-option value="infantil">Infantil</ion-select-option>
                  <ion-select-option value="biografia">Biografia</ion-select-option>
                </ion-select>
              </ion-item>
            </div>
            <div class="input-group">
              <ion-label>Opções de Entrega *</ion-label>
              <div class="checkbox-group">
                <ion-item lines="none" class="delivery-toggle" [class.active]="donateForm.get('deliveryLocalPickup')?.value">
                  <ion-checkbox class="pill" formControlName="deliveryLocalPickup" (ionChange)="donateForm.get('deliveryLocalPickup')?.setValue($event.detail.checked)" labelPlacement="end">Retirada Local</ion-checkbox>
                </ion-item>
                <ion-item lines="none" class="delivery-toggle" [class.active]="donateForm.get('deliveryShipping')?.value">
                  <ion-checkbox class="pill" formControlName="deliveryShipping" (ionChange)="donateForm.get('deliveryShipping')?.setValue($event.detail.checked)" labelPlacement="end">Envio</ion-checkbox>
                </ion-item>
              </div>
            </div>

            <div class="input-group address-section">
              <ion-label class="section-title">Endereço</ion-label>
              <div *ngIf="(authService.currentUserValue?.addresses?.length || 0) > 0; else noSavedAddress">
                <ion-segment value="{{ useSavedAddress ? 'saved' : 'new' }}" (ionChange)="useSavedAddress = $event.detail.value === 'saved'">
                  <ion-segment-button value="saved">Usar endereço salvo</ion-segment-button>
                  <ion-segment-button value="new">Adicionar novo</ion-segment-button>
                </ion-segment>
    <div *ngIf="useSavedAddress" class="address-select">
                  <ion-item class="custom-input">
                    <ion-select [(ngModel)]="selectedAddressId" [ngModelOptions]="{standalone:true}" placeholder="Selecione um endereço salvo">
                      <ion-select-option *ngFor="let a of authService.currentUserValue?.addresses" [value]="a.id">{{ a.label || (a.street + ' ' + a.number) || ('CEP ' + a.cep) }}</ion-select-option>
                    </ion-select>
                  </ion-item>
                </div>
  <div *ngIf="!useSavedAddress" class="address-form-grid">
                  <ion-grid class="no-padding">
                    <ion-row>
                      <ion-col size="12" size-md="4"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.label" [ngModelOptions]="{standalone:true}" placeholder="Apelido"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="4"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.cep" (ionInput)="onCepChange()" (ionBlur)="onCepChange()" [ngModelOptions]="{standalone:true}" placeholder="CEP *"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="4"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.street" [ngModelOptions]="{standalone:true}" placeholder="Rua"></ion-input></ion-item></ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6" size-md="3"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.number" [ngModelOptions]="{standalone:true}" placeholder="Número"></ion-input></ion-item></ion-col>
                      <ion-col size="6" size-md="3"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.complement" [ngModelOptions]="{standalone:true}" placeholder="Complemento"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="6"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.neighborhood" [ngModelOptions]="{standalone:true}" placeholder="Bairro"></ion-input></ion-item></ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6" size-md="5"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.city" [ngModelOptions]="{standalone:true}" placeholder="Cidade"></ion-input></ion-item></ion-col>
                      <ion-col size="3" size-md="2"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.state" [ngModelOptions]="{standalone:true}" placeholder="UF"></ion-input></ion-item></ion-col>
                      <ion-col size="3" size-md="3"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.country" [ngModelOptions]="{standalone:true}" placeholder="País"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="2" class="save-addr-toggle">
                        <ion-item lines="none">
                          <ion-checkbox [(ngModel)]="saveNewAddressToProfile" [ngModelOptions]="{standalone:true}" labelPlacement="end">Salvar endereço no perfil</ion-checkbox>
                        </ion-item>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                  <div class="address-help">
                    <ion-icon name="information-circle-outline"></ion-icon>
                    <span>Use o CEP para preencher automaticamente Rua, Bairro, Cidade e UF. Você pode ajustar qualquer campo antes de salvar.</span>
                  </div>
                </div>
              </div>
              <ng-template #noSavedAddress>
                <p class="placeholder">Nenhum endereço salvo. Adicione um novo para continuar.</p>
                <div class="address-form-grid">
                  <ion-grid class="no-padding">
                    <ion-row>
                      <ion-col size="12" size-md="4"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.label" [ngModelOptions]="{standalone:true}" placeholder="Apelido"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="4"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.cep" (ionInput)="onCepChange()" (ionBlur)="onCepChange()" [ngModelOptions]="{standalone:true}" placeholder="CEP *"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="4"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.street" [ngModelOptions]="{standalone:true}" placeholder="Rua"></ion-input></ion-item></ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6" size-md="3"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.number" [ngModelOptions]="{standalone:true}" placeholder="Número"></ion-input></ion-item></ion-col>
                      <ion-col size="6" size-md="3"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.complement" [ngModelOptions]="{standalone:true}" placeholder="Complemento"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="6"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.neighborhood" [ngModelOptions]="{standalone:true}" placeholder="Bairro"></ion-input></ion-item></ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="6" size-md="5"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.city" [ngModelOptions]="{standalone:true}" placeholder="Cidade"></ion-input></ion-item></ion-col>
                      <ion-col size="3" size-md="2"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.state" [ngModelOptions]="{standalone:true}" placeholder="UF"></ion-input></ion-item></ion-col>
                      <ion-col size="3" size-md="3"><ion-item class="custom-input" lines="none"><ion-input [(ngModel)]="newAddress.country" [ngModelOptions]="{standalone:true}" placeholder="País"></ion-input></ion-item></ion-col>
                      <ion-col size="12" size-md="2" class="save-addr-toggle">
                        <ion-item lines="none">
                          <ion-checkbox [(ngModel)]="saveNewAddressToProfile" [ngModelOptions]="{standalone:true}" labelPlacement="end">Salvar endereço no perfil</ion-checkbox>
                        </ion-item>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </div>
              </ng-template>
            </div>
          </ion-col>

          <ion-col size="12" size-lg="6" class="form-column">
            <div class="input-group">
              <ion-label>Descrição do Livro</ion-label>
              <ion-item class="custom-input textarea-input">
                <ion-textarea formControlName="description" [autoGrow]="true" placeholder="Detalhes sobre o livro, edição, etc."></ion-textarea>
              </ion-item>
            </div>
            <div class="input-group">
              <ion-label>Foto da Capa *</ion-label>
              <div class="image-upload-box">
                <ng-container *ngIf="!imagePreview">
                  <ion-icon name="image-outline"></ion-icon>
                  <p>JPG, PNG ou GIF (máx. 5MB)</p>
                  <ion-button size="small" fill="outline" (click)="triggerImageInputClick()">
                    Selecionar Imagem
                  </ion-button>
                </ng-container>
                <div *ngIf="imagePreview" class="image-preview-container">
                  <img [src]="imagePreview" alt="Pré-visualização da capa">
                  <ion-button class="remove-image-btn" fill="clear" color="danger" (click)="removeImage($event)">
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
              <input id="coverImageInput" type="file" accept="image/*" (change)="handleImageChange($event)" hidden>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-button type="submit" expand="block" class="submit-button" [disabled]="isSubmitting || lacksPix">
        <ion-spinner *ngIf="isSubmitting" name="crescent"></ion-spinner>
        <span *ngIf="!isSubmitting">Cadastrar Doação</span>
      </ion-button>
  <ion-note color="medium" *ngIf="lacksPix" class="ion-text-center" style="display:block;margin-top:8px;text-align:center;">
        É necessário cadastrar ao menos uma chave PIX no perfil para doar um livro.
      </ion-note>
    </form>
  </div>
</ion-content>